<%
if context.enable_extra_modules == "1"
    extra_mods = context.extra_modules
elsif context.enable_extra_modules == "0"
    extra_mods = ""
end

## Persistent preferences and login
cloudbeaver_workspace_location = "#{ENV['HOME']}/.local/share/cloudbeaver/workspace"
cloudbeaver_conf_location = "#{ENV['HOME']}/.local/share/cloudbeaver/conf"

## convenient variables for the three config files
cloudbeaver_data_sources = "#{cloudbeaver_workspace_location}/GlobalConfiguration/.dbeaver/data-sources.json"
cloudbeaver_runtime_conf = "#{cloudbeaver_workspace_location}/.data/.cloudbeaver.runtime.conf"
cloudbeaver_db_initial_data = "#{cloudbeaver_conf_location}/initial-data.conf"
%>
# Export the module function if it exists
[[ $(type -t module) == "function" ]] && export -f module

# Find available port to run server on
export port=$(find_port ${host} 32768 65535)

# Export compute node the script is running on
export host="${host}"

# Generate SHA1 encrypted password (requires OpenSSL installed)
<%- if File.exist?(cloudbeaver_db_initial_data) -%>
<% myhash = YAML.load_file(cloudbeaver_db_initial_data) %>
export password=<%= myhash["adminPassword"] %>
<%- else -%>
export password="$(create_passwd 16)"
<%- end -%>

# Export the admin user for cloudbeaver
export adminuser="$USER"

################################################################################
################################################################################

## cloudbeaver specific
export CLOUDBEAVER_WEB_SERVER_PORT=$port
export CLOUDBEAVER_ROOT_URI="/node/${host}/${port}"
export CLOUDBEAVER_APP_ANONYMOUS_ACCESS_ENABLED=false
export CLOUDBEAVER_APP_SUPPORTS_CUSTOM_CONNECTIONS=true

export CLOUDBEAVER_WORKSPACE_LOCATION=<%= cloudbeaver_workspace_location %>
export CLOUDBEAVER_CONF_LOCATION=<%= cloudbeaver_conf_location %>
export CLOUDBEAVER_DATA_SOURCES=<%= cloudbeaver_data_sources %>
export CLOUDBEAVER_RUNTIME_CONF=<%= cloudbeaver_runtime_conf %>
export CLOUDBEAVER_DB_INITIAL_DATA=<%= cloudbeaver_db_initial_data %>

# export CLOUDBEAVER_DB_USER=$adminuser
# export CLOUDBEAVER_DB_PASSWORD=$password

(
umask 077

################################################################################
################################################################################

<%- if !File.directory?(cloudbeaver_workspace_location) -%>
# if the workspace dir does not exist, go ahead and make it
mkdir -p $(dirname $CLOUDBEAVER_DATA_SOURCES)
mkdir -p $(dirname $CLOUDBEAVER_RUNTIME_CONF)
# mkdir -p ${CLOUDBEAVER_WORKSPACE_LOCATION}/.metadata
<%- end -%>

<%- if !File.directory?(cloudbeaver_conf_location) -%>
# if the config dir does not exist, go ahead and make it
mkdir -p $CLOUDBEAVER_CONF_LOCATION
<%- end -%>

################################################################################
################################################################################

<%- if !File.exist?(cloudbeaver_data_sources) -%>
cat <<EOF > $CLOUDBEAVER_DATA_SOURCES
{
  "folders": {},
  "connections": {}
}
EOF
<%- end -%>

<%- if !File.exist?(cloudbeaver_runtime_conf) -%>
cat <<EOF > $CLOUDBEAVER_RUNTIME_CONF
{
  "server": {
    "serverName": "CloudBeaver DEAC OnDemand",
    "serverURL": "https://login.deac.wfu.edu",
    "expireSessionAfterPeriod": "\${CLOUDBEAVER_EXPIRE_SESSION_AFTER_PERIOD:1800000}",
    "productSettings": {
      "core.localization.language": "\${CLOUDBEAVER_CORE_LOCALIZATION:en}",
      "core.theming.theme": "\${CLOUDBEAVER_CORE_THEMING_THEME:light}",
      "plugin.log-viewer.disabled": "\${CLOUDBEAVER_LOG_VIEWER_DISABLED:false}",
      "plugin.log-viewer.logBatchSize": "\${CLOUDBEAVER_LOG_VIEWER_LOG_BATCH_SIZE:1000}",
      "plugin.log-viewer.maxLogRecords": "\${CLOUDBEAVER_LOG_VIEWER_MAX_LOG_RECORDS:2000}",
      "plugin.sql-editor.autoSave": "\${CLOUDBEAVER_SQL_EDITOR_AUTOSAVE:true}",
      "plugin.sql-editor.disabled": "\${CLOUDBEAVER_SQL_EDITOR_DISABLED:false}",
      "plugin.sql-editor.maxFileSize": "\${CLOUDBEAVER_SQL_EDITOR_MAX_FILE_SIZE:10240}",
      "sql.proposals.insert.table.alias": "\${CLOUDBEAVER_SQL_PROPOSALS_INSERT_TABLE_ALIAS:PLAIN}"
    },
    "database": {
      "driver": "\${CLOUDBEAVER_DB_DRIVER:h2_embedded_v2}",
      "url": "\${CLOUDBEAVER_DB_URL:jdbc:h2:${CLOUDBEAVER_WORKSPACE_LOCATION}/.data/cb.h2v2.dat}",
      "user": "\${CLOUDBEAVER_DB_USER:cb-data}",
      "password": "\${CLOUDBEAVER_DB_PASSWORD:qUJd5k4L}",
      "initialDataConfiguration": "\${CLOUDBEAVER_DB_INITIAL_DATA:conf/initial-data.conf}",
      "backupEnabled": "\${CLOUDBEAVER_DB_BACKUP_ENABLED:true}",
      "pool": {
        "minIdleConnections": "\${CLOUDBEAVER_DB_MIN_IDLE_CONNECTIONS:4}",
        "validationQuery": "\${CLOUDBEAVER_DB_VALIDATION_QUERY:SELECT 1}",
        "maxIdleConnections": "\${CLOUDBEAVER_DB_MAX_IDLE_CONNECTIONS:10}",
        "maxConnections": "\${CLOUDBEAVER_DB_MAX_CONNECTIONS:100}"
      }
    },
    "sm": {
      "passwordPolicy": {
        "minLength": "\${CLOUDBEAVER_POLICY_MIN_LENGTH:8}",
        "minNumberCount": "\${CLOUDBEAVER_POLICY_MIN_NUMBER_COUNT:1}",
        "minSymbolCount": "\${CLOUDBEAVER_POLICY_MIN_SYMBOL_COUNT:0}",
        "requireMixedCase": "\${CLOUDBEAVER_POLICY_REQUIRE_MIXED_CASE:true}"
      }
    }
  },
  "app": {
    "anonymousAccessEnabled": "\${CLOUDBEAVER_APP_ANONYMOUS_ACCESS_ENABLED:true}",
    "supportsCustomConnections": "\${CLOUDBEAVER_APP_SUPPORTS_CUSTOM_CONNECTIONS:true}",
    "publicCredentialsSaveEnabled": "\${CLOUDBEAVER_APP_PUBLIC_CREDENTIALS_SAVE_ENABLED:true}",
    "adminCredentialsSaveEnabled": "\${CLOUDBEAVER_APP_ADMIN_CREDENTIALS_SAVE_ENABLED:true}",
    "enableReverseProxyAuth": false,
    "forwardProxy": "\${CLOUDBEAVER_APP_FORWARD_PROXY:false}",
    "linkExternalCredentialsWithUser": true,
    "redirectOnFederatedAuth": true,
    "resourceManagerEnabled": "\${CLOUDBEAVER_APP_RESOURCE_MANAGER_ENABLED:true}",
    "secretManagerEnabled": false,
    "showReadOnlyConnectionInfo": "\${CLOUDBEAVER_APP_READ_ONLY_CONNECTION_INFO:false}",
    "grantConnectionsAccessToAnonymousTeam": "\${CLOUDBEAVER_APP_GRANT_CONNECTIONS_ACCESS_TO_ANONYMOUS_TEAM:false}",
    "systemVariablesResolvingEnabled": "\${CLOUDBEAVER_SYSTEM_VARIABLES_RESOLVING_ENABLED:false}",
    "resourceQuotas": {
      "dataExportFileSizeLimit": "\${CLOUDBEAVER_RESOURCE_QUOTA_DATA_EXPORT_FILE_SIZE_LIMIT:10000000}",
      "resourceManagerFileSizeLimit": "\${CLOUDBEAVER_RESOURCE_QUOTA_RESOURCE_MANAGER_FILE_SIZE_LIMIT:500000}",
      "sqlMaxRunningQueries": "\${CLOUDBEAVER_RESOURCE_QUOTA_SQL_MAX_RUNNING_QUERIES:100}",
      "sqlResultSetRowsLimit": "\${CLOUDBEAVER_RESOURCE_QUOTA_SQL_RESULT_SET_ROWS_LIMIT:100000}",
      "sqlTextPreviewMaxLength": "\${CLOUDBEAVER_RESOURCE_QUOTA_SQL_TEXT_PREVIEW_MAX_LENGTH:4096}",
      "sqlBinaryPreviewMaxLength": "\${CLOUDBEAVER_RESOURCE_QUOTA_SQL_BINARY_PREVIEW_MAX_LENGTH:261120}"
    },
    "defaultNavigatorSettings": {},
    "enabledFeatures": [],
    "enabledAuthProviders": [
      "local"
    ],
    "enabledDrivers": [
      "generic:duckdb_jdbc",
      "h2:h2_embedded",
      "h2:h2_embedded_v2",
      "sqlite:sqlite_jdbc",
      "postgres:postgres_jdbc",
    ],
    "disabledDrivers": [],
    "authConfigurations": []
  }
}
EOF
<%- end -%>

<%- if !File.exist?(cloudbeaver_db_initial_data) -%>
cat <<EOF > "${CLOUDBEAVER_DB_INITIAL_DATA}"
{
    adminName: "$adminuser",
    adminPassword: "$password",
    teams: [
        {
            subjectId: "admin",
            teamName: "Admin",
            description: "Administrative access. Has all permissions.",
            permissions: [ "admin" ]
        },
        {
            subjectId: "user",
            teamName: "User",
            description: "All users, including anonymous.",
            permissions: [ ]
        }
    ]
}
EOF
<%- end -%>
)
